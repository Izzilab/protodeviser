<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html class=" zxpmxgvpr idc0_319"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<title>Pfam: Generate domain images (legacy, unofficial)</title>
<meta name="Description" content="Pfam's legacy custom domains generator.">

<script type="text/javascript" src="./index_files/prototype.js"></script>
<link rel="stylesheet" href="./index_files/prototip.css" type="text/css">

<!-- prototip -->
<script type="text/javascript" src="./index_files/prototip.js"></script>
<script type="text/javascript" src="./index_files/styles.js"></script>

<!-- global stylesheet -->
<link rel="stylesheet" href="./index_files/pfam.css" type="text/css">

<!-- required javascripts -->
<script type="text/javascript" src="./index_files/excanvas.js"></script>
<script type="text/javascript" src="./index_files/domain_graphics.js"></script>
<script type="text/javascript" src="./index_files/graphic_generator.js"></script>

<!-- styles applicable to all browsers -->
<link rel="stylesheet" href="./index_files/graphicTools.css" type="text/css">


<!-- ====================================================================== -->
<body style="padding-bottom: 0px;">
<div><input id="yui-history-field" type="hidden"></div>

<!-- header starts here -->
<div class="cleaner"><!-- empty --></div>

<div id="jsWarning" class="warningBox" style="display: none;">
  <strong>Please note:</strong> this site relies heavily on the use of javascript. 
  Without a javascript-enabled browser, this site will not function correctly. 
  Please enable javascript and reload the page, or switch to a different browser.
</div>

<script type="text/javascript">
  // <![CDATA[
  $("jsWarning").hide();

  $("siteSearchField").value = "keyword search";
  var ssCleared = false;
  // ]]>
</script>

<div id="graphic">
  <h2>Protein topology scheme (right-click to save):</h2>
  <div id="dg">
  	<span id="none">No graphic yet</span>
  </div>
</div>

<h2>Graphics settings</h2>
<div class="row">
  <span class="label" style="width:192px">Image size (scale):</span><input id="scale" value="1.0"><span class="text">&nbsp; Increase this to get a higher resolution image.</span>
</div>

<div class="row">
   <span class="label" style="width:192px">Amino acid size (pixels):</span><input id="residueWidth" value="0.5"><span class="text">&nbsp; Modify the length of the protein scheme.</span>
</div>

<div class="row">
   <span class="label" style="width:192px">Motif opacity (alpha):</span><input id="motifOpacity" value="0.6"><span class="text">&nbsp; Set the transparency level for motifs.</span>
</div>

<div class="row">
   <span class="label" style="width:192px">Image height (pixels):</span><input id="targetHeight" value="0"><span class="text">&nbsp; Set fixed height in pixels (0 = auto scale).</span>
</div>

<div class="cleaner"><!-- empty --></div>
<br>
<!--  <div id="sequence" class="panel">-->
<div class="panel">
  <!-- Batch processing input -->
  <div class="row">
    <span class="label" style="width:192px">Batch process JSON files:</span>
    <input type="file" id="batchFileInput" accept=".json" multiple />
    <button id="batchProcess" onclick="batchProcessFiles()">Process All Files</button>
  </div>

   <div class="row">
   	<!--  <button id="pasteButton">Paste clipboard contents</button>-->
	<button id="submit">Generate graphic from JSON code</button>
	<button id="clear">Clear code box</button>
   </div>
  <!-- Batch processing status -->
  <div id="batchStatus" style="display: none; margin: 10px 0; padding: 10px; border: 1px solid #ccc; background: #f9f9f9;">
    <h3>Batch Processing Status:</h3>
    <div id="progressInfo"></div>
    <div id="progressBar" style="width: 100%; height: 20px; background: #ddd; border-radius: 10px; overflow: hidden;">
      <div id="progressFill" style="width: 0%; height: 100%; background: #4CAF50; transition: width 0.3s;"></div>
    </div>
   </div>
   
   <div id="errors" style="display: none">
	<h1>Problem with domain graphics description</h1>
	<div id="error"></div>
   </div>
   
   <h2>JSON code (right click and paste or use the button above):</h2>
   <div class="panel-body">
   	<textarea cols="96" rows="24" id="seq"></textarea>
   </div>

   <div class="row">
   	<h3>Load examples:</h3>
	<button id="small">Simple</button>
   	<button id="large">Complex</button>
   </div>
</div>

<script type="text/javascript">
  // <![CDATA[

  var generator;
  var batchProcessing = false;

  // Function to load JSON from file
  function loadJsonFromFile() {
    const fileInput = document.getElementById("jsonFileInput");
    const file = fileInput.files[0];

    if (!file) {
      alert("Please select a JSON file first.");
      return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const jsonContent = e.target.result;
        // Validate JSON
        JSON.parse(jsonContent);
        document.getElementById("seq").value = jsonContent;
      } catch (error) {
        alert("Invalid JSON file: " + error.message);
      }
    };
    reader.readAsText(file);
  }

  // Function to download canvas as PNG
  function downloadCanvasAsPng(filename = "protein_domain_graphic.png") {
    const canvas = document.querySelector('canvas[id^="anonymous_element_"]');
    if (!canvas) {
      alert("No graphic generated yet. Please generate a graphic first.");
      return;
    }

    const link = document.createElement("a");
    link.download = filename;
    link.href = canvas.toDataURL("image/png");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  // Function to wait for canvas to be generated
  function waitForCanvas() {
    return new Promise((resolve) => {
      const checkCanvas = () => {
        const canvas = document.querySelector('canvas[id^="anonymous_element_"]');
        if (canvas) {
          // Wait a bit more to ensure rendering is complete
          setTimeout(() => resolve(canvas), 100);
        } else {
          setTimeout(checkCanvas, 50);
        }
      };
      checkCanvas();
    });
  }

  // Function to process a single file and generate PNG
  async function processSingleFile(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          const jsonContent = e.target.result;
          const jsonData = JSON.parse(jsonContent); // Validate JSON and parse

          // Extract accession from metadata
          let filename = file.name.replace(".json", ".png"); // fallback
          if (
            jsonData.metadata &&
            jsonData.metadata.length > 0 &&
            jsonData.metadata[0].accession
          ) {
            filename = jsonData.metadata[0].accession + ".png";
          }

          // Load JSON into textarea
          document.getElementById("seq").value = jsonContent;

          // Simulate submit button click
          document.getElementById("submit").click();

          // Wait for canvas to be generated
          await waitForCanvas();

          // Download the PNG
          downloadCanvasAsPng(filename);

          resolve(filename);
        } catch (error) {
          reject(`Error processing ${file.name}: ${error.message}`);
        }
      };
      reader.readAsText(file);
    });
  }

  // Function to batch process multiple files
  async function batchProcessFiles() {
    const fileInput = document.getElementById("batchFileInput");
    const files = Array.from(fileInput.files);

    if (files.length === 0) {
      alert("Please select JSON files for batch processing.");
      return;
    }

    batchProcessing = true;
    const statusDiv = document.getElementById("batchStatus");
    const progressInfo = document.getElementById("progressInfo");
    const progressFill = document.getElementById("progressFill");

    statusDiv.style.display = "block";

    let processed = 0;
    let errors = [];

    for (let i = 0; i < files.length; i++) {
      const file = files[i];

      try {
        progressInfo.innerHTML = `Processing: ${file.name} (${i + 1}/${files.length})`;

        await processSingleFile(file);
        processed++;

        // Add delay between files to ensure proper processing
        await new Promise(resolve => setTimeout(resolve, 500));
      } catch (error) {
        errors.push(error);
        console.error(error);
      }

      // Update progress bar
      const progress = ((i + 1) / files.length) * 100;
      progressFill.style.width = progress + "%";
    }

    // Show completion status
    let statusMessage = `Batch processing complete! Processed: ${processed}/${files.length} files`;
    if (errors.length > 0) {
      statusMessage += `\nErrors: ${errors.length}`;
      console.log("Errors encountered:", errors);
    }

    progressInfo.innerHTML = statusMessage;
    batchProcessing = false;

    // Hide status after 5 seconds
    setTimeout(() => {
      statusDiv.style.display = "none";
    }, 5000);
  }

  document.observe( "dom:loaded", function() {
    generator = new GraphicGenerator();
  } );

  // ]]>
</script>

<!-- end of content -->

<script type="text/javascript">
// <![CDATA[
Event.observe( window, 'load', addHoverListeners, false );
      // ]]>
</script>

</body>
</html>
